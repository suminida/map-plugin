<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VWorld Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        html, body, #map { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var _vworldKey = null; // Flutter에서 주입
        var map;
        var markerLayer;
        var markerSource;

        // API Key 설정 (Flutter에서 호출)
        function setApiKey(key) {
            _vworldKey = key;
        }

        // VWorld 타일 레이어 생성
        function createVWorldLayer(layerType) {
            if (!_vworldKey) {
                console.error('VWorld API Key가 설정되지 않았습니다.');
                return null;
            }
            return new ol.layer.Tile({
                source: new ol.source.XYZ({
                    crossOrigin: 'anonymous',
                    url: 'https://api.vworld.kr/req/wmts/1.0.0/' + _vworldKey + '/' + layerType + '/{z}/{y}/{x}.' + (layerType === 'Satellite' ? 'jpeg' : 'png')
                })
            });
        }

        // 지도 초기화
        function initMap(lat, lng, zoom, apiKey) {
            if (apiKey) setApiKey(apiKey);
            var satelliteLayer = createVWorldLayer('Satellite');
            var hybridLayer = createVWorldLayer('Hybrid');
            var baseLayer = createVWorldLayer('Base');

            markerSource = new ol.source.Vector();
            markerLayer = new ol.layer.Vector({
                source: markerSource,
                zIndex: 1000
            });

            map = new ol.Map({
                target: 'map',
                layers: [satelliteLayer, hybridLayer, markerLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat([lng, lat]),
                    zoom: zoom
                })
            });

            // 지도 클릭 이벤트
            map.on('click', function(evt) {
                var coord = ol.proj.toLonLat(evt.coordinate);
                sendToFlutter('onTap', { lat: coord[1], lng: coord[0] });
            });

            // 지도 이동 이벤트
            map.on('moveend', function() {
                var view = map.getView();
                var center = ol.proj.toLonLat(view.getCenter());
                sendToFlutter('onPositionChanged', {
                    lat: center[1],
                    lng: center[0],
                    zoom: view.getZoom()
                });
            });
        }

        // 센터 이동
        function setCenter(lat, lng) {
            var view = map.getView();
            view.setCenter(ol.proj.fromLonLat([lng, lat]));
        }

        // 줌 레벨 설정
        function setZoom(zoom) {
            map.getView().setZoom(zoom);
        }

        // 줌 인
        function zoomIn() {
            var view = map.getView();
            view.setZoom(view.getZoom() + 1);
        }

        // 줌 아웃
        function zoomOut() {
            var view = map.getView();
            view.setZoom(view.getZoom() - 1);
        }

        // 마커 추가
        function addMarker(id, lat, lng) {
            var iconFeature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat])),
                markerId: id
            });

            iconFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({ color: '#ff0000' }),
                    stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
                })
            }));

            markerSource.addFeature(iconFeature);

            // 마커 클릭 이벤트
            map.on('click', function(evt) {
                map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    var markerId = feature.get('markerId');
                    if (markerId === id) {
                        sendToFlutter('onMarkerTap', { id: markerId });
                    }
                });
            });
        }

        // 마커 제거
        function removeMarker(id) {
            var features = markerSource.getFeatures();
            for (var i = 0; i < features.length; i++) {
                if (features[i].get('markerId') === id) {
                    markerSource.removeFeature(features[i]);
                    break;
                }
            }
        }

        // 모든 마커 제거
        function clearMarkers() {
            markerSource.clear();
        }

        // Flutter로 메시지 전송
        function sendToFlutter(event, data) {
            var message = { event: event, data: data };
            if (window.flutter_inappwebview) {
                window.flutter_inappwebview.callHandler('mapEvent', message);
            } else if (window.FlutterChannel) {
                window.FlutterChannel.postMessage(JSON.stringify(message));
            }
        }

        // 초기화 완료 알림
        window.addEventListener('load', function() {
            sendToFlutter('onMapReady', {});
        });
    </script>
</body>
</html>
